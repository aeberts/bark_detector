# Test Design: Story 1.3 - Update the `--analyze-violations` Command

Date: 2025-09-19
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 10
- **Unit tests**: 4 (40%)
- **Integration tests**: 4 (40%)
- **E2E tests**: 2 (20%)
- **Priority distribution**: P0: 6, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Running `uv run python -m bark_detector --analyze-violations [DATE]` executes the new analysis workflow

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
|--------------|-------------|----------|-----------------------------------------|----------------------------------|
| 1.3-UNIT-003 | Unit        | P1       | Validate CLI argument parsing for date  | Input validation logic           |
| 1.3-INT-001  | Integration | P0       | Test CLI → Database persistence flow    | Multi-component critical path    |
| 1.3-INT-003  | Integration | P1       | Error handling for missing recordings   | Error flow validation            |
| 1.3-E2E-001  | E2E         | P0       | Complete workflow with real audio       | Critical user journey            |
| 1.3-E2E-002  | E2E         | P1       | Error scenario with non-existent date   | Error journey validation         |

### AC2: The correct `_events.json` and `_violations.json` files are created in the `violations/[DATE]/` directory

#### Scenarios

| ID           | Level       | Priority | Test                                           | Justification                       |
|--------------|-------------|----------|------------------------------------------------|-------------------------------------|
| 1.3-UNIT-001 | Unit        | P0       | Verify `_get_violations_file_path()` underscore| Direct bug fix validation           |
| 1.3-UNIT-002 | Unit        | P0       | Verify consistent underscore naming both files | Critical naming consistency         |
| 1.3-INT-001  | Integration | P0       | Test CLI → Database creates correct files      | Multi-component critical path       |
| 1.3-INT-002  | Integration | P0       | Verify JSON schema compliance                  | Data integrity validation           |
| 1.3-INT-004  | Integration | P1       | Test automatic directory creation              | File system integration            |
| 1.3-E2E-001  | E2E         | P0       | Complete workflow produces JSON files          | Critical user journey               |

### AC3: The `README.md` and `CHANGELOG.md` are updated to reflect the changes to this command

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
|--------------|-------------|----------|-----------------------------------------|----------------------------------|
| 1.3-UNIT-004 | Unit        | P2       | Verify documentation update requirements| Documentation validation         |

## Critical Bug Fix Focus

### Priority P0 Tests for Filename Format Bug

The critical filename format inconsistency discovered requires dedicated test coverage:

**Current Bug**: `ViolationDatabase._get_violations_file_path()` returns `{date}-violations.json` (dash)
**Expected**: `{date}_violations.json` (underscore) to match events file pattern

**Dedicated Tests**:
- `1.3-UNIT-001`: Direct method testing for underscore format
- `1.3-UNIT-002`: Cross-validation both files use consistent naming
- `1.3-INT-001`: Integration test verifies corrected files are created
- `1.3-E2E-001`: End-to-end validation with real workflow

## Test Implementation Details

### Unit Tests (4 scenarios)

**1.3-UNIT-001: Filename Format Bug Fix**
```python
def test_violations_file_path_uses_underscore_format():
    # Test direct method call returns correct underscore format
    db = ViolationDatabase(violations_dir=Path("test_violations"))
    path = db._get_violations_file_path("2025-09-19")
    assert path.name == "2025-09-19_violations.json"
```

**1.3-UNIT-002: Consistent Naming Convention**
```python
def test_events_and_violations_files_consistent_naming():
    # Verify both files use underscore pattern
    db = ViolationDatabase(violations_dir=Path("test_violations"))
    events_path = db._get_events_file_path("2025-09-19")
    violations_path = db._get_violations_file_path("2025-09-19")

    assert "_events.json" in events_path.name
    assert "_violations.json" in violations_path.name
    assert "-" not in violations_path.name  # No dashes in filename
```

### Integration Tests (4 scenarios)

**1.3-INT-001: CLI to Database Flow**
```python
def test_cli_analyze_violations_creates_correct_files():
    # Mock CLI call → verify JSON files created with correct names
    # Test complete integration: CLI → Detector → Tracker → Database
```

**1.3-INT-002: JSON Schema Validation**
```python
def test_created_json_files_match_schemas():
    # Verify PersistedBarkEvent and Violation schema compliance
    # Load generated files and validate structure
```

### E2E Tests (2 scenarios)

**1.3-E2E-001: Complete User Journey**
```python
def test_analyze_violations_complete_workflow():
    # Real CLI command execution with sample audio files
    # Verify: command succeeds + correct files created + valid content
```

## Risk Coverage

**High Risk Mitigated**:
- Filename inconsistency causing downstream failures → 1.3-UNIT-001, 1.3-UNIT-002
- CLI integration breakage → 1.3-INT-001, 1.3-E2E-001
- File creation failures → 1.3-INT-001, 1.3-INT-004, 1.3-E2E-001
- Schema validation failures → 1.3-INT-002

**Medium Risk Mitigated**:
- Error handling regressions → 1.3-INT-003, 1.3-E2E-002
- Directory creation issues → 1.3-INT-004

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on bug fix): 1.3-UNIT-001, 1.3-UNIT-002
2. **P0 Integration tests**: 1.3-INT-001, 1.3-INT-002
3. **P0 E2E tests**: 1.3-E2E-001
4. **P1 tests**: 1.3-UNIT-003, 1.3-INT-003, 1.3-INT-004, 1.3-E2E-002
5. **P2 tests**: 1.3-UNIT-004

## Quality Metrics

- **Bug fix validation**: 4 dedicated tests for filename format issue
- **Critical path coverage**: 3 levels of testing for file creation workflow
- **Error scenario coverage**: 2 dedicated error handling tests
- **Schema validation**: Dedicated integration test for data integrity

## Test Environment Requirements

- **Unit Tests**: Mock ViolationDatabase, no file system dependencies
- **Integration Tests**: Temporary test directories, mocked audio processing
- **E2E Tests**: Sample audio files, full violation analysis pipeline

## Success Criteria

✅ All P0 tests pass (critical functionality works)
✅ Filename format bug completely resolved
✅ JSON files created with correct naming and valid schemas
✅ CLI integration maintains existing behavior while adding new persistence
✅ Error handling preserved from original implementation