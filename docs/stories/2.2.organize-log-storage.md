# Story 2.3: Organize Daily Log Storage and Legacy Migration

## Status
Draft

## Story
**As a** system maintainer responsible for legal-evidence readiness,
**I want** bark-detector logs split by functional area and stored in daily folders,
**so that** operational reviews and evidence exports have clear, date-scoped audit trails without manual log triage.

## Acceptance Criteria
1. The application shall write log output for each functional channel (real-time monitoring vs. analysis workflows) to `logs/YYYY-MM-DD/YYYY-MM-DD_<channel>.log`, using the configured `logs_dir` as the root when provided. `[Source: docs/backlog.md#priority-tasks-to-discuss--plan]` `[Source: docs/improvements.md#i19-improvement--separate-logs-by-date]` `[Source: docs/configuration.md#output-directories]`
2. Monitoring flows (manual recording, calibration, default detector startup) shall log to `<date>_detection.log`, while long-running analysis/QA commands (e.g., `--analyze-violations`, `--violation-report`) shall log to `<date>_analysis.log`, ensuring both rotate daily without overwriting prior logs. `[Source: docs/architecture/component-architecture.md#modified-components]`
3. A migration script shall transform any existing `bark_detector.log` (and similarly named legacy log archives) into the new hierarchy without data loss, leaving a timestamped backup of the original flat file. `[Source: scripts/README.md#bark-recording-migration-scripts]`
4. Documentation (README, configuration guidance) shall describe the new log layout, default file names, and how to override the root directory; CHANGELOG captures the operational impact. `[Source: docs/configuration.md#output-directories]`
5. The team shall document which modules currently emit log files (including helper scripts) and confirm each either adopts the new naming convention or is explicitly exempt with justification captured in the storyâ€™s Dev Notes. `[Source: docs/backlog.md#priority-tasks-to-discuss--plan]`

## Tasks / Subtasks

- [ ] **Task 1: Extend logging configuration for channel-specific daily files** (AC: 1, 2)
  - [ ] Update `bark_detector/utils/helpers.py::setup_logging` to derive `<channel>`-specific filenames, respect `logs_dir` overrides, and ensure daily directories exist. `[Source: docs/architecture/component-architecture.md#modified-components]` `[Source: docs/configuration.md#output-directories]`
  - [ ] Introduce a lightweight logging facade (or helper) so call sites can select "detection" vs. "analysis" channels without duplicating path logic. `[Source: docs/architecture/component-architecture.md#modified-components]`
  - [ ] Ensure backward-compatible fallback when `use_date_folders=False` is requested to avoid breaking legacy tooling. `[Source: docs/architecture/enhancement-scope-and-integration-strategy.md#compatibility-requirements]`

- [ ] **Task 2: Apply channel-aware logging across entry points** (AC: 2, 5)
  - [ ] Audit CLI pathways (`--manual-record`, `--calibrate*`, `--analyze-violations`, `--violation-report`, migration scripts) and bind them to the appropriate logging channel. `[Source: docs/architecture/component-architecture.md#modified-components]`
  - [ ] Update any direct `logging` usage in scripts or modules to use the facade while preserving existing log messages and severity. `[Source: scripts/README.md#bark-recording-migration-scripts]`
  - [ ] Capture findings on auxiliary log producers (e.g., migration utilities under `scripts/`) and note required follow-up or exceptions in Dev Notes. `[Source: docs/backlog.md#priority-tasks-to-discuss--plan]`

- [ ] **Task 3: Build legacy log migration utility** (AC: 3)
  - [ ] Add `scripts/migrate_logs_by_date.py` that parses `bark_detector.log` (and optional glob of historical logs), generating per-day `<date>_analysis.log` files under `logs/<date>/`. `[Source: scripts/README.md#bark-recording-migration-scripts]`
  - [ ] Provide dry-run and backup options mirroring existing script ergonomics (e.g., JSON summary in `logs/`). `[Source: scripts/README.md#log-file-format]`
  - [ ] Include safety checks for malformed timestamps and emit a summary banner to stdout for operator verification. `[Source: scripts/README.md#safety-features]`

- [ ] **Task 4: Update operational documentation** (AC: 4)
  - [ ] Document new log destinations and override instructions in `README.md` and `docs/configuration.md`. `[Source: docs/configuration.md#output-directories]`
  - [ ] Add CHANGELOG entry summarizing log hierarchy changes and migration availability. `[Source: docs/improvements.md#i19-improvement--separate-logs-by-date]`
  - [ ] Provide operator runbook snippet showing how to run the migration script and verify outputs. `[Source: scripts/README.md#migration-process]`

- [ ] **Task 5: Testing & validation** (AC: 1, 2, 3)
  - [ ] Add unit tests for new logging helper ensuring correct paths for detection vs. analysis channels under default and overridden `logs_dir`. `[Source: docs/sample_based_testing.md#testing-framework]`
  - [ ] Add integration tests (pytest) verifying CLI commands create the correct log files in isolated temp directories. `[Source: docs/architecture/tech-stack-alignment.md#existing-technology-stack]`
  - [ ] Add tests for migration script (including dry-run) to confirm correct file creation and backup behavior. `[Source: scripts/README.md#safety-features]`
  - [ ] Update or add regression tests ensuring legacy `bark_detector.log` handling still functions when `use_date_folders=False`. `[Source: docs/architecture/enhancement-scope-and-integration-strategy.md#compatibility-requirements]`

## Dev Notes

### Previous Story Insights
Story 2.1 contains no Dev Agent completion notes; no implementation lessons recorded to inherit. `[Source: docs/stories/2.1.implement-dual-sensitivity-bark-detection.md#dev-agent-record]`

### Logging Improvement Context
Product backlog highlights the need to separate logs by day and channel for easier evidence preparation. `[Source: docs/backlog.md#priority-tasks-to-discuss--plan]`

### Architecture Responsibilities
CLI orchestration and supporting utilities coordinate logging setup, so updates must traverse `cli.py` and shared helpers without fragmenting the pipeline. `[Source: docs/architecture/component-architecture.md#modified-components]`

### Configuration Outputs
`logs_dir` is part of the configurable output structure; honor overrides when placing new files and ensure documentation reflects defaults. `[Source: docs/configuration.md#output-directories]`

### Improvement Specification
Prior improvement notes already call for per-day log separation, providing motivation and expected operator experience. `[Source: docs/improvements.md#i19-improvement--separate-logs-by-date]`

### Script Conventions
Existing migration tooling under `scripts/` emphasises dry-run support, JSON logging, and safety features; mirror these ergonomics in the new log migration utility. `[Source: scripts/README.md#bark-recording-migration-scripts]`

### Tech Stack & Testing Expectations
All changes must remain Python 3.11 compatible, executed via `uv run`, and validated with pytest + pytest-mock per established standards. `[Source: docs/architecture/tech-stack-alignment.md#existing-technology-stack]`

## Testing

### Testing Standards
- Use `uv run pytest` with pytest/pytest-mock per project convention. `[Source: docs/architecture/tech-stack-alignment.md#existing-technology-stack]`
- Prefer temporary directories and fixtures to validate log path generation. `[Source: docs/sample_based_testing.md#testing-framework]`

### Required Scenarios
- Unit coverage for path composition of detection vs. analysis channels under various config overrides.
- Integration coverage for CLI flows confirming correct log files appear in temp `logs/` directories.
- Migration script tests covering dry-run, actual execution, malformed lines, and backup creation.
- Regression test ensuring fallback flat-file logging remains available when explicitly requested.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 0.1 | Initial draft defining daily/channel log storage and migration requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]
