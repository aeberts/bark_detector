# Story 3.5: Overwrite Mode for Analyze Violations

## Status
Done

## Story
**As a** system user running violation analysis on dates that may already have analysis files,
**I want** configurable overwrite behavior for the `--analyze-violations` command,
**so that** I can control whether existing analysis files are overwritten, appended to, or prompt for user choice.

## Acceptance Criteria
1. Add new configuration option `overwrite_mode` to the Legal configuration section with two possible values: "overwrite" (default) and "prompt"
2. The `overwrite_mode` option must be configurable both in config.json and via a new CLI argument `--overwrite-mode`
3. When `overwrite_mode` is "overwrite" (default behavior):
   - The system should non-interactively overwrite existing `YYYY-MM-DD_events.json` and `YYYY-MM-DD_violations.json` files
   - Log a message to the analysis log stating that existing files were found and are being overwritten
4. When `overwrite_mode` is "prompt":
   - If existing files are found, prompt the user with three options:
     - `q)` quit and do nothing, leaving existing files unchanged
     - `o)` overwrite the existing events.json and violations.json files with new analysis
     - `a)` append new analysis to existing files (merge new data with existing data)
   - Handle each user choice appropriately and log the action taken
5. The append functionality (`a` option) must preserve existing data structure and add new events/violations to the existing arrays
6. All existing `--analyze-violations` functionality must remain unchanged when using default "overwrite" mode

## Tasks / Subtasks
- [x] Task 1: Extend Legal Configuration (AC: 1, 2)
  - [x] Add `overwrite_mode` field to `LegalConfig` dataclass with default value "overwrite"
  - [x] Add validation for overwrite_mode values ("overwrite", "prompt") in `_dict_to_config` method
  - [x] Update CLI argument parser to include `--overwrite-mode` option
  - [x] Integrate CLI overwrite_mode argument into `merge_cli_args` method

- [x] Task 2: Implement File Existence Check Logic (AC: 3, 4, 5)
  - [x] Add method to ViolationDatabase to check if analysis files already exist for a given date
  - [x] Create helper method to handle user prompting with q/o/a options when mode is "prompt"
  - [x] Implement file append logic that merges new events/violations with existing data
  - [x] Add appropriate logging for overwrite actions and user choices

- [x] Task 3: Integrate Overwrite Logic into Analysis Pipeline (AC: 3, 4, 5, 6)
  - [x] Modify `save_events` method to respect overwrite_mode configuration
  - [x] Modify `save_violations_new` method to respect overwrite_mode configuration
  - [x] Ensure backward compatibility by maintaining default overwrite behavior
  - [x] Add error handling for file operation failures during append operations

- [x] Task 4: Unit Testing (AC: 1-6)
  - [x] Test LegalConfig overwrite_mode validation and defaults
  - [x] Test CLI argument parsing for --overwrite-mode
  - [x] Test ViolationDatabase file existence detection
  - [x] Test append functionality maintains data integrity
  - [x] Test prompt mode user interaction scenarios (mock input testing)
  - [x] Test overwrite mode logging behavior

## Dev Notes

### Previous Story Insights
From Story 3.4, the violation analysis system uses the ViolationDatabase to save analysis results to date-partitioned JSON files. This story builds on that established file handling pattern.

### Data Models
The system uses two main JSON file types per date:
- `YYYY-MM-DD_events.json`: Contains PersistedBarkEvent objects with metadata wrapper
- `YYYY-MM-DD_violations.json`: Contains Violation objects with metadata wrapper

File structure example: `violations/2025-09-28/2025-09-28_events.json`
[Source: architecture/data-models-and-schema-changes.md#new-data-models, architecture/source-tree.md#operational-artefacts]

### Configuration System
- Configuration handled via `bark_detector/utils/config.py` with `LegalConfig` dataclass
- CLI arguments merged via `merge_cli_args` method with CLI taking precedence
- JSON config files support nested structure under "legal" section
[Source: architecture/tech-stack.md#application-structure]

### File Locations
- Configuration logic: `bark_detector/utils/config.py` (LegalConfig class, ConfigManager)
- Database operations: `bark_detector/legal/database.py` (ViolationDatabase class)
- CLI argument parsing: `bark_detector/cli.py` (add_argument calls, merge_cli_args usage)
- Main analysis pipeline: `bark_detector/core/detector.py` (analyze_violations_for_date method)
[Source: architecture/source-tree.md#application-package]

### Technical Constraints
- Must preserve evidence integrity and timestamps per legal requirements
- File operations must be atomic to prevent corruption during interruption
- JSON schema backward compatibility required for existing analysis files
- uv run prefix required for all Python command execution
[Source: architecture/coding-standards.md#guiding-principles, architecture/tech-stack.md#tooling-package-management]

### Current File Save Implementation
ViolationDatabase currently uses simple file overwrites in `save_events()` and `save_violations_new()` methods:
```python
with open(events_file, 'w') as f:
    json.dump(events_data, f, indent=2)
```
[Source: bark_detector/legal/database.py lines 119-120, 182-183]

### Testing
- Test files location: `tests/test_legal/` for ViolationDatabase tests
- Use pytest framework with `uv run pytest` execution
- Mock file operations and user input for testing prompt scenarios
- Integration tests in `tests/test_integration/` for CLI-level scenarios
[Source: architecture/coding-standards.md#testing-quality-gates, architecture/source-tree.md#tests]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-28 | 1.0 | Initial story creation | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- All tests pass for new overwrite mode functionality
- Integration with existing configuration system working correctly
- CLI argument parsing functional for --overwrite-mode option

### Completion Notes List
- Successfully implemented configurable overwrite behavior for violation analysis
- Added prompt mode with user interaction for q/o/a choices
- Implemented append functionality that preserves data integrity
- All acceptance criteria met and tested
- Backward compatibility maintained with default overwrite behavior
- Comprehensive test suite added covering all functionality

### File List
**Modified Files:**
- `bark_detector/utils/config.py` - Added overwrite_mode field to LegalConfig, validation, and CLI integration
- `bark_detector/cli.py` - Added --overwrite-mode CLI argument
- `bark_detector/legal/database.py` - Enhanced save methods with overwrite logic, added file existence checks and append functionality
- `bark_detector/legal/tracker.py` - Integrated overwrite_mode from config to database calls

**New Files:**
- `tests/test_legal/test_overwrite_mode.py` - Comprehensive test suite for overwrite mode functionality

## QA Results

### Review Date: 2025-09-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - This implementation demonstrates high-quality software engineering practices with comprehensive feature coverage, robust error handling, and excellent test coverage. All acceptance criteria are fully implemented with thoughtful consideration for user experience and data integrity.

**Key Strengths:**
- **Complete Requirements Traceability**: All 6 acceptance criteria are fully implemented and tested
- **Robust Configuration System**: Proper validation and integration across config files and CLI arguments
- **User-Centric Design**: Interactive prompting provides clear options with meaningful feedback
- **Data Integrity**: Append functionality preserves existing data structure while merging seamlessly
- **Comprehensive Testing**: 18 test cases covering all scenarios including edge cases and user interactions
- **Backward Compatibility**: Default "overwrite" behavior maintains existing functionality

### Refactoring Performed

No refactoring was necessary. The implementation is well-structured and follows project coding standards effectively.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to PEP 8, type hints, dataclasses, and project conventions
- **Project Structure**: ✓ Proper file organization, module separation, and dependency injection
- **Testing Strategy**: ✓ Comprehensive test coverage with mocking, fixtures, and integration scenarios
- **All ACs Met**: ✓ Complete implementation of all 6 acceptance criteria with validation

### Requirements Traceability Analysis

**AC1: Configuration Option** ✓ FULLY COVERED
- `LegalConfig.overwrite_mode` field with default "overwrite"
- Tests: `test_legal_config_default_overwrite_mode`, `test_legal_config_custom_overwrite_mode`

**AC2: CLI Integration** ✓ FULLY COVERED
- `--overwrite-mode` CLI argument with validation
- Config merging with CLI precedence
- Tests: `test_cli_argument_parsing`, `test_merge_cli_args_overwrite_mode`

**AC3: Overwrite Mode Behavior** ✓ FULLY COVERED
- Non-interactive overwrite with logging
- Tests: `test_save_events_overwrite_mode_overwrite_existing`

**AC4: Prompt Mode Behavior** ✓ FULLY COVERED
- Interactive user prompting with q/o/a options
- Tests: `test_prompt_overwrite_choice_*` series

**AC5: Append Functionality** ✓ FULLY COVERED
- Data structure preservation with array merging
- Tests: `test_append_events_functionality`, `test_save_events_prompt_mode_append`

**AC6: Backward Compatibility** ✓ FULLY COVERED
- Default behavior unchanged, existing functionality preserved
- Tests: `test_save_events_overwrite_mode_default`

### Architecture Review

**Design Patterns**: Excellent use of dependency injection, configuration management, and separation of concerns. The implementation properly integrates with existing `ViolationDatabase` and `LegalViolationTracker` architecture.

**Error Handling**: Comprehensive exception handling for file operations, user input validation, and graceful degradation scenarios.

**Data Flow**: Clear data flow from CLI → Config → Tracker → Database with proper parameter propagation through the system.

### Security Review

**Input Validation**: ✓ PASS
- CLI argument validation with restricted choices
- Configuration validation in `ConfigManager._validate_overwrite_mode`
- No injection vulnerabilities identified

**File Operations**: ✓ PASS
- Atomic file operations with proper directory creation
- Safe file handling with exception management
- No path traversal vulnerabilities

### Performance Considerations

**Startup Impact**: ✓ MINIMAL
- Configuration loading happens once at startup
- No performance degradation to existing workflows

**Runtime Impact**: ✓ NEGLIGIBLE
- Append operations efficiently merge arrays
- User prompting only occurs when explicitly configured

### Test Architecture Assessment

**Coverage Depth**: ✓ EXCELLENT (18 comprehensive test cases)
- Unit tests for all configuration components
- Integration tests for CLI argument parsing
- Mock-based tests for user interaction scenarios
- Data integrity tests for append operations

**Test Design Quality**: ✓ HIGH
- Proper use of fixtures and teardown
- Comprehensive mocking for user input
- Edge case coverage including error scenarios

**Maintainability**: ✓ EXCELLENT
- Clear test organization by functionality
- Descriptive test names and documentation
- Isolated test scenarios without dependencies

### Files Modified During Review

No files were modified during this review. The implementation is production-ready as delivered.

### Gate Status

Gate: PASS → docs/qa/gates/3.5-overwrite-mode-for-analyze-violations.yml
Quality Score: 95/100
Risk Profile: LOW (0 critical, 0 high, 0 medium, 0 low risk issues)

### Recommended Status

✓ **Ready for Done** - All acceptance criteria fully implemented with excellent code quality, comprehensive testing, and full backward compatibility. This feature is ready for production deployment.