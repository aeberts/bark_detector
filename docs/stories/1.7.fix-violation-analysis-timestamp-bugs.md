# Story 1.7: Fix Violation Analysis Timestamp and Session Grouping Bugs

## Status
Not Implemented - Superceded by: `./1.9.fix-violation-detection-algorithm-bug.md`

## Story
**As a** user collecting legal evidence for bylaw violations,
**I want** the violation analysis system to correctly handle timestamps and session grouping across multiple audio files,
**so that** intermittent violation detection avoids false positives and constant violation detection correctly identifies legitimate violations spanning multiple sessions.

## Acceptance Criteria
1. Intermittent violation detection shall use absolute timestamps when grouping sessions across multiple audio files to prevent false positives caused by relative timestamp resets
2. Session grouping logic shall correctly calculate gaps between sessions from different recordings using real-world timestamps derived from audio file names
3. Constant violation detection shall identify legitimate violations that span multiple sessions with brief pauses (e.g., 4.5min + 20s pause + 4.5min = 9min total)
4. The violation analysis system shall implement either duration-based detection or wider gap thresholds for constant violations to handle real-world barking patterns
5. All existing violation analysis functionality shall remain intact with no regression in legitimate violation detection
6. The fix shall include comprehensive test coverage validating both bug scenarios with realistic multi-file test cases

## Tasks / Subtasks

- [ ] **Task 1: Fix Intermittent Violation Timestamp Bug** (AC: 1, 2)
  - [ ] Modify `_events_to_sessions()` method in `bark_detector/legal/tracker.py` to accept recording start time offset parameter
  - [ ] Update `analyze_recordings_for_date()` to pass recording start timestamp to session creation
  - [ ] Convert all event timestamps to absolute time before session grouping by adding recording offset from filename parsing
  - [ ] Ensure `_group_sessions_for_sporadic_analysis()` operates on absolute timestamps to prevent negative gaps
  - [ ] Update session creation logic to maintain backward compatibility for single-file analysis

- [ ] **Task 2: Fix Constant Violation Detection Logic** (AC: 3, 4)
  - [ ] Analyze current constant violation detection logic in `analyze_violations()` method (lines 43-47)
  - [ ] Implement duration-based detection that examines elapsed time across session sequences
  - [ ] Add logic to merge sessions with gaps ≤60 seconds for constant violation analysis (configurable threshold)
  - [ ] Restore elapsed-duration checks pattern from `bd_original.py:334-409` for reference
  - [ ] Ensure single-session constant violations (≥5 minutes) continue to work as before

- [ ] **Task 3: Create Comprehensive Test Coverage** (AC: 6)
  - [ ] Create test cases with multiple audio files demonstrating intermittent false positive bug
  - [ ] Create test cases with 9-minute scenarios (4.5min + pause + 4.5min) for constant detection
  - [ ] Add test validation for absolute timestamp conversion across multiple recordings
  - [ ] Add regression tests ensuring existing legitimate violations are still detected
  - [ ] Add edge case tests for single-file analysis to ensure no regression

- [ ] **Task 4: Integration Testing and Validation** (AC: 5)
  - [ ] Run full test suite to ensure no regression in existing functionality
  - [ ] Test with real audio files from sample recordings to validate fix effectiveness
  - [ ] Verify CLI commands `--analyze-violations` produce accurate results for multi-file dates
  - [ ] Update any related documentation if analysis behavior changes

## Dev Notes

### Bug Analysis from Code Review
The violation analysis system has two critical high-severity bugs identified in the codebase review:

**Bug 1: Intermittent Violation False Positives**
- **Root Cause**: `_events_to_sessions()` processes each audio file independently with relative timestamps (0-based), but `_group_sessions_for_sporadic_analysis()` treats all sessions as if they're on a continuous timeline
- **Code Location**: `bark_detector/legal/tracker.py:217` (start_time = events[0].start_time), lines 288-332 (sporadic grouping)
- **Impact**: Files restart at t=0, creating negative/short gaps between recordings, causing all sessions to collapse into one giant group

**Bug 2: Constant Violation False Negatives**
- **Root Cause**: Current logic requires ≥300s in single session, but 10s gaps split sessions inappropriately
- **Code Location**: `bark_detector/legal/tracker.py:43-47` (constant detection logic)
- **Impact**: Legitimate 9-minute violations split into multiple <300s sessions = no violation detected

### Technical Architecture Context

**Data Models** [Source: architecture/data-models-and-schema-changes.md]:
- `PersistedBarkEvent` model stores individual bark events with `realworld_date`, `realworld_time`, `bark_id`, `confidence`, `intensity`
- `Violation` model stores processed violations with `violation_type`, `violation_start_time`, `violation_end_time`, `bark_event_ids`

**Component Integration** [Source: architecture/component-architecture.md]:
- `bark_detector/legal/tracker.py` (Analysis Engine): Responsible for processing audio and persisting results via ViolationDatabase
- `bark_detector/legal/database.py` (Persistence Layer): Manages read/write operations for `_events.json` and `_violations.json` files
- Integration must maintain the existing data persistence pipeline

**File Locations**:
- Primary implementation: `bark_detector/legal/tracker.py` methods `_events_to_sessions()`, `analyze_violations()`, `_group_sessions_for_sporadic_analysis()`
- Test files: `tests/test_legal/test_violation_tracker.py` (extend with multi-file test cases)
- Reference implementation: `bd_original.py:334-409` (elapsed-duration checks for constant violations)

### Testing Standards
- **Test Framework**: pytest with pytest-mock for mocking [Source: architecture/tech-stack-alignment.md]
- **Test File Location**: `tests/test_legal/` directory following existing pattern
- **Integration Requirements**: Tests must validate bug fixes without breaking existing 280+ tests
- **Mock Strategy**: Use existing YAMNet and audio processing mocks, extend for multi-file scenarios

### Previous Story Context
Stories 1.1-1.3 implemented the data persistence layer and violation analysis engine. Story 2.1 added dual-sensitivity detection. This story addresses critical bugs discovered in the implementation that affect legal evidence accuracy.

### Technical Constraints
- **Python Version**: 3.11.4 [Source: architecture/tech-stack-alignment.md]
- **Package Manager**: All commands must use `uv run` prefix
- **Backward Compatibility**: Existing CLI workflows must continue functioning unchanged
- **Performance**: Fix must not introduce significant performance degradation
- **Legal Evidence Integrity**: Fixes are critical for legal evidence accuracy for City of Kelowna complaints

## Testing
### Testing Requirements
- **Framework**: pytest with comprehensive mocking for audio processing and YAMNet
- **Coverage Areas**: Multi-file timestamp handling, session grouping logic, violation detection accuracy
- **Regression Testing**: Ensure all existing 280+ tests continue passing
- **Integration Testing**: End-to-end validation with realistic multi-file scenarios
- **Test Location**: `tests/test_legal/test_violation_tracker.py` (extend existing file)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial story creation addressing critical timestamp bugs | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]