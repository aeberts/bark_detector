# Story 3.4: Enhanced Bark Activity Chart Visualization

## Status
Draft

## Story
**As a** system user investigating noise violations,
**I want** an enhanced Bark Activity Chart that shows comprehensive bark activity from 6am to 8pm with color-coded bark events,
**so that** I can visualize the full extent of daily bark activity beyond just violations to better understand barking patterns and evidence context.

## Acceptance Criteria
1. The x-axis time scale of the Bark Activity Chart must start at 06:00am and end at 20:00pm (14-hour window)
2. All bark events from the day must be displayed on the timeline with appropriate color coding:
   - Red: Bark events that are part of constant (continuous) violations
   - Orange: Bark events that are part of intermittent violations
   - Gray: All other bark events (standalone barks not part of any violation)
3. The chart must maintain existing violation visualization while adding individual bark event representation
4. The chart must preserve existing PDF generation performance and quality
5. The enhanced chart must display accurately for dates with varying amounts of bark activity (from few events to high-activity days)
6. All existing chart functionality (title, legend, axis labels) must be preserved and enhanced appropriately

## Tasks / Subtasks
- [ ] Task 1: Modify _generate_activity_timeline method to implement 6am-8pm time window (AC: 1)
  - [ ] Update x-axis limits from current 24-hour (0-23) to 14-hour window (6-20)
  - [ ] Adjust time tick labels to reflect 6am-8pm range
  - [ ] Update chart title and axis labels to reflect focused time window
- [ ] Task 2: Implement comprehensive bark event visualization (AC: 2, 3)
  - [ ] Extract all bark events from the provided bark_events parameter
  - [ ] Create mapping logic to categorize bark events by violation association:
    - Events with bark_id in continuous violation barkEventIds → red
    - Events with bark_id in intermittent violation barkEventIds → orange
    - All other events → gray
  - [ ] Add individual bark event scatter points to the chart alongside existing violation bars
  - [ ] Ensure bark events are visually distinguishable from violation aggregation bars
- [ ] Task 3: Update chart styling and legend (AC: 6)
  - [ ] Add legend entries for individual bark events (red dots, orange dots, gray dots)
  - [ ] Preserve existing legend for violation bars (red bars, orange bars)
  - [ ] Ensure chart remains readable with both violation bars and bark event points
  - [ ] Adjust chart layout if needed to accommodate additional visual elements
- [ ] Task 4: Write comprehensive tests (AC: 4, 5)
  - [ ] Unit tests for bark event categorization logic
  - [ ] Unit tests for 6am-8pm time window rendering
  - [ ] Integration tests with various bark activity scenarios (low, medium, high activity)
  - [ ] Performance tests to ensure PDF generation remains efficient
  - [ ] Visual regression test to verify chart quality and readability

## Dev Notes

### Previous Story Insights
From Story 3.3 completion notes: PDF generation service is successfully integrated with CLI. The _generate_activity_timeline method currently creates 24-hour bar charts showing violation intensity by hour. This story enhances that existing functionality.

### Data Models [Source: architecture/data-models-and-schema-changes.md]
- **PersistedBarkEvent**: Contains `bark_id`, `realworld_date`, `realworld_time`, `confidence`, `intensity`, `audio_file_name` attributes needed for individual event visualization
- **Violation**: Contains `barkEventIds` array that maps to `bark_id` values in PersistedBarkEvent, used for color-coding bark events by violation association
- **Violation.type**: Values are "Continuous" (constant violations, red) or "Intermittent" (orange)

### Component Specifications [Source: architecture/source-tree.md]
- **File Location**: `bark_detector/utils/pdf_generator.py` - Shared utilities for report generation
- **Method to Modify**: `_generate_activity_timeline()` method within PDFGenerationService class
- **Current Implementation**: Creates hourly bar chart with matplotlib, returns ReportLab Image object
- **Dependencies**: matplotlib.pyplot, matplotlib.dates, ReportLab Image, datetime handling

### Technical Constraints [Source: architecture/coding-standards.md]
- **Evidence Integrity**: Must preserve timestamps and confidence scores in visualization accuracy
- **Deterministic Behavior**: Chart generation must produce consistent results across different machines
- **Performance**: Chart generation must not significantly impact PDF creation time
- **Type Hints**: Use proper type hints for new parameters and return values
- **Logging**: Route error messages through configured logging instance, avoid bare print statements

### Testing Standards
- **Test Framework**: pytest with `pytest-mock` and `pytest-cov`
- **Test Location**: `tests/test_utils/test_pdf_generator.py` for unit tests
- **Test Location**: `tests/test_integration/test_pdf_integration.py` for integration scenarios
- **Execution Command**: `uv run pytest tests/`
- **Coverage Focus**: Chart generation logic, bark event categorization, time window handling
- **Mock Strategy**: Mock matplotlib for unit tests, use real generation for integration tests
- **Fixtures**: Use real-world bark event and violation data from `violations/` directory when available

### Specific Testing Requirements for This Story
- Test bark event categorization with mixed violation types
- Test time window rendering accuracy (6am-8pm bounds)
- Test chart readability with varying bark event densities
- Test performance impact on PDF generation workflow
- Test edge cases: no bark events, all events in violations, no violations but many bark events

### File Locations [Source: architecture/source-tree.md]
- **Primary Implementation**: `bark_detector/utils/pdf_generator.py`
- **Unit Tests**: `tests/test_utils/test_pdf_generator.py`
- **Integration Tests**: `tests/test_integration/test_pdf_integration.py`
- **Generated Output**: `reports/` directory for PDF files

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-27 | 1.0 | Initial story creation for enhanced bark activity chart visualization | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)