# Story 3.1: Unify Violation Data Models & Refactor Core Logic

## Status
Draft

## Story
**As a** system maintainer working on the violation report generation overhaul,
**I want** the codebase to use a single, consistent set of data models for violations and bark events,
**so that** data conversion and duplicated logic is eliminated, creating a solid foundation for the new PDF reporting system.

## Acceptance Criteria
1. All violation-related data models shall be unified into a single, consistent schema
2. The existing `ViolationReport` model shall be refactored to become a presentation-layer object
3. Duplicated logic between different violation handling components shall be eliminated
4. The new unified data models shall maintain backward compatibility with existing persisted data
5. All existing tests shall pass with the refactored data models
6. The refactoring shall prepare the foundation for subsequent PDF generation implementation

## Tasks / Subtasks
- [ ] Task 1: Analyze current data model inconsistencies (AC: 1)
  - [ ] Identify all violation-related data models in the codebase
  - [ ] Document current data conversion points and duplicated logic
  - [ ] Map relationships between existing models
- [ ] Task 2: Design unified data model schema (AC: 1, 2)
  - [ ] Create consolidated `Violation` model specification
  - [ ] Design presentation-layer `ViolationReport` refactoring approach
  - [ ] Ensure schema supports both current and future PDF reporting needs
- [ ] Task 3: Implement unified violation data models (AC: 1, 2, 4)
  - [ ] Refactor `bark_detector/legal/models.py` with unified models
  - [ ] Update `PersistedBarkEvent` and `Violation` models as needed
  - [ ] Implement backward compatibility layer for existing JSON schemas
- [ ] Task 4: Refactor ViolationReport to presentation layer (AC: 2, 3)
  - [ ] Convert `ViolationReport` to presentation-only object
  - [ ] Remove business logic from `ViolationReport` class
  - [ ] Update report generation to use unified models
- [ ] Task 5: Eliminate duplicated violation logic (AC: 3)
  - [ ] Consolidate violation processing in `bark_detector/legal/tracker.py`
  - [ ] Remove redundant violation handling code from other components
  - [ ] Ensure single source of truth for violation business rules
- [ ] Task 6: Update database persistence layer (AC: 4)
  - [ ] Modify `bark_detector/legal/database.py` to use unified models
  - [ ] Implement migration support for existing violation data
  - [ ] Test backward compatibility with existing JSON files
- [ ] Task 7: Update all tests and ensure compatibility (AC: 5)
  - [ ] Update unit tests in `tests/test_legal/` for new models
  - [ ] Verify integration tests pass with refactored components
  - [ ] Test with real violation data samples to ensure compatibility

## Dev Notes

### Previous Story Insights
This is the foundation story for Epic 1: Violation Report Generation Overhaul. The current system has inconsistent data models and duplicated logic that must be addressed before implementing PDF generation.

### Data Models
**Current State Analysis** [Source: architecture/data-models-and-schema-changes.md]:
- `PersistedBarkEvent`: Raw persistent log with attributes: `realworld_date`, `realworld_time`, `bark_id`, `bark_type`, `est_dog_size`, `audio_file_name`, `bark_audiofile_timestamp`, `confidence`, `intensity`
- `Violation`: Logical separation from ViolationReport with attributes: `violation_id`, `violation_type`, `violation_date`, `violation_start_time`, `violation_end_time`, `bark_event_ids`
- Schema generates two files per analysis day: `[YYYY-MM-DD]_events.json` and `[YYYY-MM-DD]_violations.json`

**Integration Strategy** [Source: architecture/data-models-and-schema-changes.md]:
- `ViolationReport` model will be refactored to presentation-layer object, generated on-the-fly from raw `Violation` data
- Migration strategy requires running `--analyze-violations` for historical recording dates to back-populate new structure

### Component Specifications
**Modified Components** [Source: architecture/component-architecture.md]:
- `bark_detector/legal/tracker.py`: Refactor to be sole engine for analysis, processing audio and persisting results via ViolationDatabase
- `bark_detector/legal/database.py`: Enhance to manage read/write operations for new `_events.json` and `_violations.json` files
- `bark_detector/utils/report_generator.py`: Refactor to read data exclusively from ViolationDatabase, decoupling from application logs

### File Locations
**Source Tree Structure** [Source: architecture/source-tree.md]:
- Primary models location: `bark_detector/legal/models.py`
- Database persistence: `bark_detector/legal/database.py`
- Legal analysis engine: `bark_detector/legal/tracker.py`
- Operational artifacts: `violations/<date>/` containing `<date>_events.json` and `<date>_violations.json`

### Testing Requirements
**Test Organization** [Source: architecture/source-tree.md]:
- Legal analysis specs: `tests/test_legal/`
- Integration tests: `tests/test_integration/`
- Fixture data: `tests/fixtures/` and real-world JSON samples in `violations/`

**Testing Standards** [Source: architecture/coding-standards.md]:
- Run `uv run pytest` locally before publishing changes
- Use fixture data or trimmed real-world JSON samples when validating violation logic
- Include CLI smoke tests for features affecting command-line behavior
- Target high-value coverage prioritizing legal analysis paths

### Technical Constraints
**Evidence Preservation** [Source: architecture/coding-standards.md]:
- Any change must preserve integrity of violation evidence (timestamps, ordering, confidence scores)
- Analysis pipelines must produce repeatable results across different machines
- Keep persisted JSON schemas backward compatible with migration logic in ViolationDatabase

**Python Standards** [Source: architecture/coding-standards.md]:
- Use dataclasses for domain entities with immutable fields unless mutation required
- Prefer type hints on public functions
- Handle filesystem paths with `pathlib.Path`
- Route messages through configured logging instance

### Project Structure Notes
The unified data models align well with the existing architecture. The main modification points are within the established `bark_detector/legal/` module structure, maintaining the separation of concerns between analysis (tracker), persistence (database), and presentation (report_generator).

## Testing
**Test Location**: `tests/test_legal/`
**Test Standards**:
- Use pytest framework with `uv run pytest` execution
- Focus on legal analysis, report generation, and CLI orchestration paths
- Use fixture data from `tests/fixtures/` or real-world JSON samples
- Include integration tests in `tests/test_integration/` for CLI-level scenarios
**Testing Requirements**:
- Verify backward compatibility with existing violation JSON files
- Test data model serialization/deserialization
- Validate migration logic for historical data
- Ensure presentation layer properly converts from unified models

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*