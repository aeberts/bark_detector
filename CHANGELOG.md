# CHANGELOG

## 2025-09-15

### Major Refactoring
- **Story 1.1: Data Persistence Layer Refactoring**: Implemented comprehensive date-partitioned data persistence system with separate event and violation storage. Created new `PersistedBarkEvent` and `Violation` data models with full JSON serialization/deserialization support. Enhanced ViolationDatabase with new methods: `save_events()`, `load_events()`, `save_violations_new()`, and `load_violations_new()` for handling `[YYYY-MM-DD]_events.json` and `[YYYY-MM-DD]_violations.json` files in date-organized directory structure (`violations/[YYYY-MM-DD]/`). Added comprehensive unit test coverage (37 tests) validating model serialization, file operations, directory creation, error handling, and backward compatibility. Maintains full compatibility with existing ViolationReport-based workflows while providing foundation for enhanced raw data analysis and debugging capabilities. System now supports separation of raw detection data from formatted presentation layer, enabling more sophisticated violation analysis and legal evidence collection.

## 2025-08-23

### Critical Bug Fixes
- **T21: Fixed Recording Filename Timestamp Bug**: Resolved critical issue where bark recording filenames contained END timestamps instead of START timestamps, causing incorrect bark-to-audio-file correlation in analysis tools. Root cause was `save_recording()` using `datetime.now()` (recording end time) instead of capturing timestamp when recording begins. Added `recording_start_time` field to AdvancedBarkDetector class, captured start time when first bark detected and recording begins, and modified `save_recording()` to use stored start time for filename generation. This ensures filenames like `bark_recording_20250823_103237.wav` represent when recording STARTED, enabling accurate legal evidence correlation. Updated documentation and comments throughout codebase to clarify timestamp meaning. All existing tests pass, confirming backward compatibility maintained while fixing correlation accuracy for enhanced violation reports and legal analysis features.
- **Migration Scripts for Existing Recordings**: Created comprehensive one-time migration scripts in `scripts/` directory to rename 1,600+ existing recordings from END timestamps to START timestamps. Features include: space-efficient renaming (no file copying), reversible operations via JSON logging, dry-run mode for safety, cross-platform compatibility, comprehensive error handling, and progress reporting. Scripts support Intel Mac deployment for production use. Includes detailed documentation and rollback capability for emergency recovery.

## 2025-08-18

### Bug Fixes
- **I18 Enhanced Violation Report Fixes**: Fixed critical TypeError in `--enhanced-violation-report` on Intel Mac where violation timestamp parsing failed with "unsupported type for timedelta seconds component: str". Root cause was legal violation models returning various timestamp formats (HH:MM AM/PM, 24-hour format, full datetime strings) instead of numeric seconds. Implemented robust multi-format datetime parsing supporting: 12-hour AM/PM format ("6:25 AM"), 24-hour format ("20:47:39"), full datetime strings ("2025-08-15 20:47:39"), and time-only formats. Added comprehensive error handling to gracefully skip violations with invalid timestamp formats rather than crashing. Enhanced test coverage with validation for multiple timestamp formats and error scenarios. System now handles all timestamp variations gracefully on all platforms.
- B9: Fixed `--violation-report` not outputting actual report files. Root cause was CLI command only logging violation information to console without creating any files. Implemented comprehensive report generation in ViolationDatabase.generate_violation_report() method that creates structured reports in reports/ directory organized by date. Reports include detailed TXT analysis, CSV data export, executive summary file, and automatic copying of all referenced audio files to audio_evidence/ subfolder. Enhanced CLI to utilize new report generation and provide user feedback about created files. Addresses I16 improvement requirement for organized report storage.
- B8: Fixed `--analyze-violations` creating duplicate violations when run multiple times for same date. Root cause was ViolationDatabase.add_violation() appending violations without checking for existing data. Implemented comprehensive duplicate detection system with has_violations_for_date(), remove_violations_for_date(), and add_violations_for_date() methods. Enhanced LegalViolationTracker with interactive parameter offering users three options when duplicates detected: overwrite existing violations, keep existing data, or add alongside. Non-interactive mode defaults to overwrite for testing compatibility. Prevents database pollution while maintaining flexibility for different use cases.
- B7: Fixed `--violation-report` not finding violations created with `--analyze-violations`. Root cause was LegalViolationTracker creating violations but not saving them to ViolationDatabase for persistence. Enhanced LegalViolationTracker.__init__() to accept ViolationDatabase parameter and modified analyze_recordings_for_date() to save detected violations to database after analysis. End-to-end workflow now functions correctly: `--analyze-violations` detects and persists violations, `--violation-report` retrieves and displays saved violations from database.

### Major Improvements
- **I18 Enhancement: Log-Based Violation Report System**: Implemented comprehensive enhanced violation reporting system with time-of-day formatting and detailed per-audio-file bark analysis. Created LogBasedReportGenerator with sophisticated log parsing capabilities that extract bark detection events from date-organized log files, correlate detections with audio files, and generate reports matching specifications in improvements.md. Added --enhanced-violation-report CLI command for generating time-formatted violation summaries with precise HH:MM:SS timestamps, duration calculations, and per-audio-file bark breakdowns. System leverages rich real-time detection data from logs to provide 1-to-1 correspondence between bark detections and audio file timestamps for legal evidence preparation. Enhanced log organization with automatic date-based folder structure (logs/YYYY-MM-DD/) for better file management and report generation accuracy.
- **Sample-Based Testing System (T9)**: Implemented comprehensive real-world testing infrastructure using actual audio recordings with precise ground truth annotations. Created SampleDataLoader and DetectionEvaluator with 1-second tolerance windows and 0.65+ confidence thresholds for practical bark detection validation. Added 12 comprehensive tests covering individual sample accuracy, multi-sample analysis, confidence threshold compliance, false positive monitoring, and regression protection. System demonstrates 77.6% F1 score overall with 100% precision and 63.3% recall across large and small dog bark samples. All 123 tests passing (added 12 new sample-based tests to existing 111-test suite).
- **Violation Analysis Enhancement**: Complete overhaul of `--analyze-violations` functionality to use advanced YAMNet bark detection instead of simple file duration analysis. Now properly analyzes audio content using ML model to detect actual bark events and create accurate barking sessions. Implemented comprehensive sporadic violation detection (15+ minutes across multiple sessions within 5-minute gaps) alongside existing continuous violation detection (5+ minutes per session). Enhanced LegalViolationTracker with _detect_sporadic_violations(), _group_sessions_for_sporadic_analysis(), and _create_sporadic_violation_report() methods.

### Bug Fixes
- Fixed failing tests caused by I13 accuracy improvements: Updated file calibration tests to mock soundfile.read instead of accessing non-existent test files, fixed detector tests to handle new _get_bark_scores() tuple return value and _scores_to_events() class_details parameter. Fixed legal violation tracker tests to properly mock advanced bark detector with required attributes and methods.

### Improvements
- **TensorFlow Debug Output Suppression**: Implemented comprehensive suppression of TensorFlow debug messages that were cluttering console output during YAMNet model loading and inference operations. Created dedicated tensorflow_suppression utility with aggressive suppression for Intel Mac compatibility. Added TF_CPP_MIN_LOG_LEVEL=3, TF_ENABLE_ONEDNN_OPTS=0, TF_FORCE_GPU_ALLOW_GROWTH, CUDA_VISIBLE_DEVICES environment variables, TensorFlow logger configuration (ERROR level), and comprehensive warning filters across all entry points (cli.py, detector.py, bd.py). Eliminates extensive "DEBUG INFO Executor start aborting" messages, CPU optimization warnings, and "pkg_resources is deprecated" warnings. Provides clean console output while maintaining error reporting for both Apple Silicon and Intel Macs.
- I2: Implemented comprehensive JSON-based configuration system supporting all current CLI features. Added ConfigManager with validation, automatic file search paths (./config.json, ~/.bark_detector/config.json), and CLI precedence handling. Created config.json and config-example.json templates. Integrated --config and --create-config CLI options with backward compatibility. Includes 32 comprehensive tests covering configuration loading, validation, CLI integration, and error handling. System supports detection parameters, output directories, calibration settings, scheduling options, and legal thresholds with proper validation and error messages.

## 2025-08-15

### Bug Fixes
- B6: Fixed CLI arguments missing after T2 refactor. Restored 11 critical CLI arguments that were removed during modular architecture transition including --calibrate-files, --audio-files, --ground-truth-files, --save-profile, --convert-files, --convert-directory, --list-violations, --record, --duration, --create-template, --sensitivity-range, and --steps. Implemented complete handlers for all argument types using test-driven development. User's file-based calibration workflows now function correctly.

### Improvements
- I13 Phase 1: Implemented intelligent YAMNet class filtering to reduce false positives by 54%. Enhanced bark detection with comprehensive class-level analysis system that identifies problematic YAMNet classes. Excluded broad classes ("Animal", "Wild animals") that were causing environmental noise false positives. Improved precision from 58.1% to 71.4% while maintaining detection capability. Added detailed detection logging with per-class confidence scoring and false positive analysis tools for ongoing accuracy optimization.
- I12: Implemented comprehensive ground truth format conversion from decimal seconds to HH:MM:SS.mmm format. Added time conversion utilities with flexible format parsing (HH:MM:SS.mmm, MM:SS.mmm, SS.mmm), enhanced GroundTruthEvent model with dual format support and validation, created batch conversion script with data quality fixes, and updated all tests. Improved data integrity by fixing inverted timestamps and duration confusion in sample files. All 60 tests passing.

## 2025-08-14

### Major Refactoring
- T2: Completed full modular architecture refactor of bd.py (3,111 lines) into clean package structure. Created bark_detector package with core/, calibration/, legal/, recording/, and utils/ modules. Maintained 100% backwards compatibility via bd.py wrapper while providing modern `python -m bark_detector` interface. Enables easier maintenance, testing, and future development.

### Bug Fixes
- B5: Fixed critical bug where refactored bd.py exited immediately after startup. Root cause was incomplete monitoring loop implementation during T2 refactoring. Added complete PyAudio stream setup, monitoring loop with `while self.is_running`, and all supporting detection methods. Program now stays running correctly and responds to Ctrl+C for graceful shutdown.
- B6: Fixed "zero-dimensional arrays cannot be concatenated" error when pressing Ctrl+C during monitoring. Root cause was inconsistent audio data storage method (extend vs append) between original and refactored versions. Changed recording data storage to use append() and added comprehensive error handling for edge cases.

### Testing Infrastructure
- T8: Implemented comprehensive project testing plan with 4-phase approach. Created pytest infrastructure with 45/45 core tests passing covering: data models, YAMNet ML integration, legal violation detection, CLI functionality. Features sophisticated YAMNet/TensorFlow mocking, comprehensive fixtures, and end-to-end integration testing for the modular architecture.
- Fixed calibration test import paths broken by T2 modular refactoring. Updated test mocking from module-specific paths to direct library patches, resolving 5 failing file calibration tests.

### Improvements
- I11: Implemented date-based folder organization for recordings. New recordings are saved to `recordings/YYYY-MM-DD/` subdirectories while maintaining backward compatibility with existing flat structure recordings.